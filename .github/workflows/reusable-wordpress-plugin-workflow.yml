name: WordPress Plugin Reusable Workflow

on:
  workflow_call:
    inputs:
      plugin_slug:
        description: 'WordPress.org plugin slug'
        required: true
        type: string
      php_version:
        description: 'PHP version to test (default: 8.1)'
        required: false
        type: string
        default: '8.1'
      wordpress_version:
        description: 'WordPress version to test (default: latest)'
        required: false
        type: string
        default: 'latest'
      enable_deploy:
        description: 'Enable WordPress.org deploy on tags'
        required: false
        type: boolean
        default: true
      phpcs_standard:
        description: 'PHPCS standard (default: WordPress)'
        required: false
        type: string
        default: 'WordPress'
    secrets:
      SVN_USERNAME:
        description: 'WordPress.org SVN username'
        required: false
      SVN_PASSWORD:
        description: 'WordPress.org SVN password'
        required: false

jobs:
  quality-checks:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php_version }}
          coverage: none

      - name: PHPCS Check
        uses: chekalsky/phpcs-action@v1
        with:
          enable_warnings: true
          standard: ${{ inputs.phpcs_standard }}

      - name: WordPress Vulnerability Scanner
        uses: 10up/wpvulnerability-scanner@v1
        with:
          fail_on_error: true

  build:
    name: Build Plugin ZIP
    runs-on: ubuntu-latest
    needs: quality-checks
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build WordPress Plugin ZIP
        uses: 10up/action-wordpress-plugin-build-zip@stable
        with:
          generate-zip: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload ZIP as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.plugin_slug }}-zip
          path: ${{ github.event.repository.name }}.zip
          retention-days: 30

  deploy:
    name: Deploy to WordPress.org
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/') && inputs.enable_deploy
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: WordPress Plugin Deploy
        uses: 10up/action-wordpress-plugin-deploy@stable
        env:
          SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
          SLUG: ${{ inputs.plugin_slug }}
        with:
          generate-zip: true
